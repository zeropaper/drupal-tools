module.exports=function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a['default']}:function(){return a};return b.d(c,'a',c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p='',b(b.s=1)}([function(a){a.exports=require('fs-extra')},function(a,b,c){a.exports=c(2)},function(a,b,c){'use strict';Object.defineProperty(b,'__esModule',{value:!0});var d=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};const{resolve:e,relative:f,basename:g,dirname:h}=c(3),{statSync:i,readFile:j}=c(0),{remove:k,ensureDir:l,readJson:m,writeJson:n}=c(0),{exec:o,spawn:p}=c(4),{promisify:q}=c(5),r=c(6),s=c(7),t=q(o),u=(a)=>a.reduce((a,b)=>!b||-1<a.indexOf(b)?a:(a.push(b),a),[]);class v{constructor(a,b,c=null){this.idKey=b,this.objectKeys=Object.keys(a||{}),this.objectKeys.forEach((b)=>this[b]=a[b]),this.collection=c}get id(){return this[this.idKey]}toJSON(){const a={};return this.objectKeys.forEach((b)=>a[b]=this[b]),a}}b.Model=v;class w{constructor(a,b){this.Model=a,this._data=[],this.reset(b)}get data(){return this._data}get length(){return this._data.length}toJSON(){return this._data.map((a)=>a.toJSON())}add(a={}){const b=new this.Model(a,this),c=this._data.findIndex((a)=>a.id===b.id);return-1<c||this._data.push(b),this}reset(a){return a.forEach(this.add),this}map(a){return this._data.map(a)}find(a){return this._data.find(a)}findBy(a,b){return this.find((c)=>c[a]===b)}filter(a){return this._data.filter(a)}filterBy(a,b){return this.filter((c)=>c[a]===b)}forEach(a){return this._data.forEach(a),this}}b.Collection=w;class x extends v{constructor(a={},b=null){super(a,'machine name',b)}}b.DrupalSite=x;class y extends v{constructor(a={},b=null){super(a,'machine name',b)}}b.DrupalLibrary=y;class z extends v{constructor(a={},b=null){super(a,'machine name',b)}get dependencyTree(){const{collection:a,dependencies:b=[]}=this;let c=b;return c.forEach((b)=>{const d=a.findBy('id',b);return d?void(c=[...c,b,...d.dependencyTree]):void console.warn('could not determine dependency',b)}),u(c)}}b.DrupalModule=z;class A extends v{constructor(a={},b=null){super(a,'machine name',b)}}b.DrupalThemeEngine=A;class B extends v{constructor(a={},b=null){super(a,'machine name',b)}get baseThemes(){const a=this.collection.findBy('machine name',this['base theme']);return a?[a.id,...a.baseThemes]:[]}}b.DrupalTheme=B;class C extends v{constructor(a={},b=null){super(a,'machine name',b)}}b.DrupalVendor=C;const D=(a)=>({stdout:JSON.parse(a.stdout||'null'),stderr:a.stderr});class E{constructor({rootPath:a,siteURI:b,drushBin:c='./vendor/bin/drush',composerBin:d='composer',themeName:e='bartik',adminThemeName:f='seven',activeModuleNames:g=[]}){if(!i(a).isDirectory())throw new Error(`"${a}" is not a directory.`);this.siteURI=b,this.rootPath=a,this.drushBin=c,this.composerBin=d,this.themeName=e,this.adminThemeName=f,this.activeModuleNames=g||[],this.sites=new w(x,[]),this.themes=new w(B,[]),this.modules=new w(z,[]),this.libraries=new w(y,[]),this.engines=new w(A,[]),this.vendors=new w(C,[])}get site(){return this.sites.findBy('id',this.siteURI)}get theme(){return this.themes.findBy('id',this.themeName)}get adminTheme(){return this.themes.findBy('id',this.adminThemeName)}get activeModules(){return this.modules.filter((a)=>this.activeModuleNames.contains(a.id))}get searchPattern(){return`{modules,themes,core/modules,core/themes,sites/{all,${this.siteURI}}}`}absPath(a){return`${this.rootPath}/${a}`}typeToCollection(a){return{theme:this.themes,module:this.modules,theme_engine:this.engines,vendor:this.vendors,site:this.sites,library:this.libraries}[a]}readInfoFile(a){return new Promise(function(b,e){var f,i,k,l,m,n;let o;return f=this._scanned.templates,i=g(g(a,'.info.yml'),'.info.yaml'),Promise.resolve(j(this.absPath(a),'utf8')).then(function(g){try{k=g,l=s.load(k),o={};try{o=!function(){var a=new Error('Cannot find module "/home/vale/repos/_perso/drupal-tools/src/core"');throw a.code='MODULE_NOT_FOUND',a}()}catch(a){try{o=c(8)(`./${i}.${l.type}.js`)}catch(a){console.warn('drupal-tools no implementation for "%s" module.',i)}}return m=h(a),n={},f.forEach((a)=>{if(!(0!==a.indexOf(m)||1>a.indexOf('.html.twig'))){const b=a.split('-').join('_');n[b]=a}}),console.log('templates for %s %s',i,l.type,o),b(d({},l,{js:o,templates:n,"info file":a,"machine name":i}))}catch(a){return e(a)}}.bind(this),e)}.bind(this))}readInfo(a){return new Promise(function(b){const c=this;if(c._info&&!a)return b(c._info);const d=(this._scanned||{info:[]}).info||[];return b(Promise.all(d.map((a)=>this.readInfoFile(a))).then((a)=>{const b={};return a.forEach((a)=>{if(a.type){b[a.type]=b[a.type]||[],b[a.type].push(a);const d=c.typeToCollection(a.type);d?d.add(a):console.log('no collection for %s',a.type)}}),c._info=b,b}))}.bind(this))}getFilename(a,b,c=null){const d=this._info[a].find((a)=>b===a['machine name']);return!!d&&`${h(d['info file'])}${c?`/${c}`:''}`}getPath(a,b){return this.getFilename(a,b)}getTemplate(){return console.info('getTemplate theme',this.theme),console.info('getTemplate activeModules',this.activeModules),!1}invokeAll(a,b){this.modules.forEach((c)=>{c.js&&'function'==typeof c.js[a]&&c.js[a](...b)})}invokeTheme(a,b){const c=this.theme.baseThemes;c.forEach((c)=>{c.js&&'function'==typeof c.js[a]&&c.js[a](...b)});this.theme.js&&'function'==typeof this.theme.js[a]&&this.theme.js[a](...b)}preprocess(a,b){b.theme_hook_original=a,this.invokeAll('preprocess',[b,a]),this.invokeAll(`preprocess_${a}`,[b]),this.invokeTheme('preprocess',[b,a]),this.invokeTheme(`preprocess_${a}`,[b])}render(a,b,c={}){const{debug:d}=c,e=`Missing theme implementation for "${a}".`;let f='';const g='';return this.preprocess(a,b),d&&(f=`\n<!-- THEME ${a} Start -->${f}`,f=`${g}<!-- THEME ${a} End -->\n`),`${f}${e}${g}`}binExec(a,b={}){return t(a,d({cwd:this.rootPath,maxBuffer:Infinity},b)).then(D)}drush(a){return this.binExec(`${this.drushBin} --uri=${this.siteURI} ${a} --format=json`)}composer(a){return this.binExec(`${this.composerBin} --format=json ${a}`)}scan(a){if(a&&this._scanned)return this._scanned;this._scanned=!1;const{searchPattern:b,rootPath:c}=this,d={info:'info.{yml,yaml}',styles:'{css,scss,sass,less}',scripts:'{js,jsx}',templates:'html.twig'},e=Object.keys(d),g={root:c},h=(a)=>a.map((a)=>f(g.root,a)).filter((a)=>0>a.indexOf('test')),i=(a,b)=>(c,d)=>c?void b(c):void a(h(d));return Promise.all(e.map((a)=>{const c=d[a],e=`/${b}/**/*.${c}`;return new Promise((a,b)=>{r(e,g,i(a,b))})})).then((a)=>{const b={};return a.forEach((a,c)=>{b[e[c]]=a}),this._scanned=b,b})}static dockerInstall(a={}){return new Promise(function(b){const{destination:c='./drupal',version:d='8'}=a;return b()}.bind(this))}static dockerRun(){return new Promise(function(a){return a()}.bind(this))}static composerInstall(a={}){return new Promise(function(b,c){function f(){return b()}var g,h,i,j,o,q,r;({composerBin:g='composer',destination:h='./drupal',composerOptions:i={},version:j='8.x-dev',stability:o='dev',siteURI:q='default'}=a),r=[()=>new Promise(function(a,b){return console.log('create-project: remove destination'),Promise.resolve(k(h)).then(function(){try{return a()}catch(a){return b(a)}}.bind(this),b)}.bind(this)),()=>new Promise((a,b)=>{console.log('create-project: composer');const c=['create-project',`drupal-composer/drupal-project:${j}`,h,'--stability',o,'--no-interaction'],d=p(g,c);let e='';d.stderr.on('data',(a)=>{e+=a}),d.on('close',(c)=>0===c?void a():(console.error('stderr',e),void b(new Error(`Process exited with code "${c}".`)))),d.on('error',b)}),()=>new Promise(function(a,b){var c;let f;return console.log('create-project: override composer.json'),c=e(`${h}/composer.json`),Promise.resolve(m(c)).then(function(e){try{return f=e,f=d({},f,i),Promise.resolve(n(c,f,{spaces:2})).then(function(){try{return a()}catch(a){return b(a)}}.bind(this),b)}catch(a){return b(a)}}.bind(this),b)}.bind(this)),()=>new Promise(function(a){return console.log('create-project: create site directories'),a(l(`${h}/sites/${q}/files`))}.bind(this)),()=>new Promise(function(a){return console.log('create-project: create settings.php'),a()}.bind(this)),()=>new Promise(function(a){return console.log('create-project: create local.settings.php'),a()}.bind(this)),()=>new Promise(function(a){return console.log('create-project: display server configuration'),console.log(`- Edit the ${h}/sites/sites.php file

- Add "0.0.0.0\t${q}" to your hosts file (/etc/hosts)

- Create a file called ${q}.conf in /etc/apache2/sites-available with the following content:

  <VirtualHost *:80>
    # The ServerName directive sets the request scheme, hostname and port that
    # the server uses to identify itself. This is used when creating
    # redirection URLs. In the context of virtual hosts, the ServerName
    # specifies what hostname must appear in the request's Host: header to
    # match this virtual host. For the default virtual host (this file) this
    # value is not decisive as it is used as a last resort host regardless.
    # However, you must set it for any further virtual host explicitly.
    ServerName ${q}
    ServerAlias *.${q}

    ServerAdmin webmaster@${q}
    DocumentRoot ${h}

    # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
    # error, crit, alert, emerg.
    # It is also possible to configure the loglevel for particular
    # modules, e.g.
    #LogLevel info ssl:warn

    # ErrorLog $\{APACHE_LOG_DIR}/error.log
    # CustomLog $\{APACHE_LOG_DIR}/access.log combined
    ErrorLog ${h}/error.log
    CustomLog ${h}/access.log combined

    # For most configuration files from conf-available/, which are
    # enabled or disabled at a global level, it is possible to
    # include a line for only one particular virtual host. For example the
    # following line enables the CGI configuration for this host only
    # after it has been globally disabled with "a2disconf".
    #Include conf-available/serve-cgi-bin.conf
    <Directory />
      Options FollowSymLinks
      AllowOverride All
      Require all granted
    </Directory>
  </VirtualHost>

- Enable the new Apache host: sudo a2ensite /etc/apache2/sites-available/${q}.conf

- Reload Apache configuration: sudo service apache2 reload

- Visit http://${q}/install.php to finalize the installation of Drupal.`),a()}.bind(this))];{function a(){return(d[1]=d[0].next()).done||!(b=d[1].value)&&0?[1]:Promise.resolve(b()).then(function(){try{return a}catch(a){return c(a)}}.bind(this),c)}let b,d=[r[Symbol.iterator]()];var s;return(s=function(b){for(;b;){if(b.then)return void b.then(s,c);try{if(b.pop){if(b.length)return b.pop()?f.call(this):b;b=a}else b=b.call(this)}catch(a){return c(a)}}}.bind(this))(a)}}.bind(this))}}b['default']=E},function(a){a.exports=require('path')},function(a){a.exports=require('child_process')},function(a){a.exports=require('util')},function(a){a.exports=require('glob')},function(a){a.exports=require('yaml-js')},function(a,b,c){function d(a){return c(e(a))}function e(a){var b=f[a];if(!(b+1))throw new Error('Cannot find module \''+a+'\'.');return b}var f={"./block.module.js":9,"./comment.module.js":10};d.keys=function(){return Object.keys(f)},d.resolve=e,a.exports=d,d.id=8},function(a,b){'use strict';Object.defineProperty(b,'__esModule',{value:!0}),b.preprocess=function(a,b){console.log('block implementation preprocess',b)},b.preprocess_block=function(){console.log('block implementation preprocess_block')}},function(a){a.exports={preprocess:(a,b)=>{console.log('comment implementation of preprocess',b)}}}]);
//# sourceMappingURL=index.js.map